
<style>
   span.drag-source {
      border: 1px solid grey;
      border-radius: 3px;
      padding: 2px;
      background-color: silver;
   }

   ul.fancytree-container {
      max-height: 800px;
      overflow-y: scroll;
      width: 80%;
      display: inline-block;
   }
   #tree ul.fancytree-container {
      float: left;
   }

   span.fancytree-node.fancytree-drag-source {
      outline: 1px dotted grey;
   }
   span.fancytree-node.fancytree-drop-accept {
      outline: 1px dotted green;
   }
   span.fancytree-node.fancytree-drop-reject {
      outline: 1px dotted red;
   }

</style>

<div id="wbsEditorContent">
   <a id="bt_loadTree" style="text-decoration: none" href="{$page}">
      <img align="absmiddle" src="images/b_refresh.png" style="vertical-align: middle;" > {t}Reload{/t}</a>

   <div id="fancytree">
      <!-- Tree wrapper -->
      <div id="tree"></div>

   </div>
</div>

<script src="lib/jquery.cookie/jquery.cookie.js" type="text/javascript"></script>

<link href="lib/fancytree/dist/skin-lion/ui.fancytree.min.css" rel="stylesheet">
<script src="lib/fancytree/dist/jquery.fancytree-all-deps.min.js"></script>

<link href="lib/contextmenu/jquery.contextMenu.css" rel="stylesheet"/>
<script src="lib/contextmenu/jquery.contextMenu.js" type="text/javascript"></script>


<script type="text/javascript">

   // TODO put this JS in a wbsFancytreeEditor.js file and minify...

   // global: nodesToDelete list
   var nodesToDelete = [];

   function addContextMenu() {

      jQuery.contextMenu({
        selector: '#tree .fancytree-folder',
        callback: function(key, options) {

            // implement contextMenu actions
            var node = $.ui.fancytree.getNode(options.$trigger);
            node.setActive();

            // TODO if root element, disable 'delete' menu option

            switch (key) {
               case 'edit':
                  node.editStart();
                  break;
               case 'add':
                  node.editCreateNode('child', { title: "{t}New Folder{/t}", folder: true });
                  break;
               case 'delete':
                  if (node.getLevel() !== 1 && !node.hasChildren()) {
                      // option 'defaultKey' => default null: generates default keys like that: "_" + counter)
                      if ('_' !== node.key.charAt(0)) {
                         console.log("node "+node.key+" exist in codevtt DB and must be removed when saving the tree");
                         nodesToDelete.push(node.key);
                      }
                      node.remove();
                  } else if (node.getLevel() == 1) {
                     console.error("Root element cannot be deleted.")
                     alert("{t}Root element cannot be deleted.{/t}");
                  } else {
                     console.error("Delete Failed: Folder must be empty.")
                     alert("{t}Delete Failed: Folder must be empty.{/t}");
                  }
                  break;
            }
        },
        items: {
            "edit": { name: "{t}Rename{/t}", icon: "edit" },
            "add": { name: "{t}Add subfolder{/t}", icon: "add" },
            "sep1": "---------",
            "delete": { name: "{t}Delete{/t}", icon: "delete", disabled: false }
        }
      });
   }

   // --------------------------------------------
	function initTree() {

       jQuery("#tree").fancytree({
         extensions: ["dnd5", "edit"],

         source: {
           type: "POST",
           url: 'include/fancytree_ajax.php',
           data: { wbsRootId: "{$wbsRootId}",
                   hasDetail: "0",
                   action: "loadWBS"
           }
         },
         // https://github.com/mar10/fancytree/wiki/ExtDnd5
         dnd5: {
            autoExpandMS: 500,          // Expand nodes after n milliseconds of hovering.
            preventForeignNodes: true,  // Prevent dropping nodes from another Fancytree
            preventRecursion: true,     // Prevent dropping nodes on own descendants
            preventVoidMoves: true,     // Prevent moving nodes 'before self', etc.
            preventNonNodes: true,      // Prevent dropping items other than Fancytree nodes
            effectAllowed: "all",       // Restrict the possible cursor shapes and modifier operations
            dropEffectDefault: "move", // "auto",

            // TODO (later)
            //multiSource: false,           // true: Drag multiple (i.e. selected) nodes.

            // --- Ennable Drag-support:
            dragStart: function(sourceNode, data) {
              // dragStart: Callback(sourceNode, data), return true, to enable dragging
               if (1 === sourceNode.getLevel()) {
                     console.error("Root element cannot be moved");
                     return false;
               }
              data.effectAllowed = "all";
              data.dropEffect = "move";
              return true;
            },

            // --- Enable Drop-support:
            dragEnter: function(targetNode, data) {
               // dragEnter: Callback(targetNode, data), return true, to enable dropping
               data.dropEffect = "move";
               return true;
            },
            dragOver: function(targetNode, data) {
               // rem: data.otherNode is the one that is selected & moved

               if(!targetNode.folder && data.hitMode === "over"){
                 //console.warn("dragOver: No, this is not a folder, you can't drop it here !");
                 // data.dropEffect = "link"; // TODO how to set a "forbidden" mouse pointer ???
                 return false;
               }

              // Assume typical mapping for modifier keys
              data.dropEffect = data.dropEffectSuggested;
              // data.dropEffect = "move";
            },
            dragDrop: function(targetNode, data) {
              // This function MUST be defined to enable dropping of items on the tree.

               if(!targetNode.folder){
                 console.error("No! you cant drop an element ("+data.otherNode.key+") on an leaf "+targetNode.key);
                 return false;
               }

               if( data.otherNode ) {
                 data.otherNode.moveTo(targetNode, data.hitMode);
               } else {
                 // Drop a non-node (should not happen, see preventNonNodes)
                 console.error("drop non-node !");
               }
               targetNode.setExpanded();
            }

           }, // dnd5

            // -----------------------
            edit: {
              //triggerStart: ["clickActive", "dblclick", "f2", "mac+enter", "shift+click"],
              triggerStart: ["clickActive", "dblclick"],
              beforeEdit: function(event, data){
               if(!data.node.folder){
                 console.warn("No! you can only edit folders");
                 return false;
               }
               if (1 >= data.node.getLevel() ) {
                 console.warn("No! you can't edit the root element "+data.node.getLevel());
                 return false;
               }
              },
              edit: function(event, data){
                // Editor was opened (available as data.input)
              },
              beforeClose: function(event, data){
                // Return false to prevent cancel/save (data.input is available)
              },
              save: function(event, data){
                // Save data.input.val() or return false to keep editor open
                //data.node.setTitle(data.node.title + "!");
                // We return true, so ext-edit will set the current user input as title
                return true;
              },
              close: function(event, data){
                // Editor was removed
                //if( data.save ) {

              }
            } // edit
        });

        addContextMenu();
     }


     // TODO !
      function saveTree() {

         var deferred = jQuery.Deferred();

         var json = $("#tree").fancytree("getRoot").toDict(true, function(dict){
            delete dict.isLazy;
            delete dict.tooltip;
            delete dict.href;
            //delete dict.icon;
            delete dict.addClass;
            delete dict.noLink;
            delete dict.activate;
            delete dict.focus;
            //delete dict.expand;
            delete dict.select;
            delete dict.hideCheckbox;
            delete dict.unselectable;
         }).children;
         var jsonDict = JSON.stringify(json);
         $.ajax({
            type: "POST",
              url: 'include/fancytree_ajax.php',
              data: { jsonDynatreeDict: jsonDict,
                      nodesToDelete: nodesToDelete,
                      wbsRootId: "{$wbsRootId}",
                      action: "saveWBS"
              },
              success: function() {
                 nodesToDelete = [];
                 //alert("WBS Saved!");
                 console.log("saveWBS: OK");
                 $("#result").html('WBS saved.');
                 // call the 'done' callback (should be defined)
                 deferred.resolve();
              },
              error:  function() {
                 alert("WBS Save ERROR!");
                 console.error("WBS Save ERROR!")
                 deferred.reject(); // call the 'fail' callback (if defined)
              }
         });
         return deferred;
      }

	  window.onload = initTree;


</script>


