
<script src="lib/jquery.cookie/jquery.cookie.js" type="text/javascript"></script>

<link href="lib/fancytree/dist/skin-lion/ui.fancytree.min.css" rel="stylesheet">
<script src="lib/fancytree/dist/jquery.fancytree-all-deps.min.js"></script>

<link href="lib/contextmenu/jquery.contextMenu.css" rel="stylesheet"/>
<script src="lib/contextmenu/jquery.contextMenu.js" type="text/javascript"></script>

<style>
   span.drag-source {
      border: 1px solid grey;
      border-radius: 3px;
      padding: 2px;
      background-color: silver;
   }

   ul.fancytree-container {
      max-height: 800px;
      overflow-y: scroll;
      width: 80%;
      display: inline-block;
   }
   #tree ul.fancytree-container {
      float: left;
   }

   span.fancytree-node.fancytree-drag-source {
      outline: 1px dotted grey;
   }
   span.fancytree-node.fancytree-drop-accept {
      outline: 1px dotted green;
   }
   span.fancytree-node.fancytree-drop-reject {
      outline: 1px dotted red;
   }

   span.trashcan {
      border: 1px solid #f5c6cb;
     background-color: #f8d7da;
     color: #721c24;
     padding: 1px 3px;
   }
</style>

<div id="content">
   <a id="bt_loadTree" style="text-decoration: none" href="{$page}">
      <img align="absmiddle" src="images/b_refresh.png" style="vertical-align: middle;" > {t}Reload{/t}</a>

   <div id="testFancytree">
      <h2>test Fancytree EDIT & SAVE</h2>

      <!-- Tree wrapper -->
      <div id="tree"></div>

   </div>
</div>

<script type="text/javascript">

   // --- Fancytree Doc ---
   // http://wwwendt.de/tech/fancytree/doc/jsdoc/FancytreeNode.html


   // --------------------------------------------
   jQuery(document).ready(function() {
   });



   // --------------------------------------------
   function addContextMenu() {

      jQuery.contextMenu({
        selector: '#tree .fancytree-folder',
        callback: function(key, options) {

            // implement contextMenu actions
            //var node = $.ui.fancytree.getNode(this);
            var node = $.ui.fancytree.getNode(options.$trigger);
            node.setActive();
            switch (key) {
               case 'rename':
                  node.editStart();
                  break;
               case 'add':
                  node.editCreateNode('child', { title: "{t}New Folder{/t}", folder: true })
                  break;
               case 'delete':
                  deleteNode(node);
                  break;
            }
        },
        items: {
            "rename": { name: "{t}Rename{/t}", icon: "edit" },
            "add": { name: "{t}Add subfolder{/t}", icon: "add" },
            "sep1": "---------",
            "delete": { name: "{t}Delete{/t}", icon: "delete" }
        }
      });
   }

   // --------------------------------------------
	function initTree() {

       jQuery("#tree").fancytree({
         extensions: ["dnd5"],

         source: {
           type: "POST",
           url: 'include/fancytree_ajax.php',
           data: { wbsRootId: "574870", // "{$wbsRootId}",
                   hasDetail: "0",
                   action: "loadWBS"
           }
         },
         // https://github.com/mar10/fancytree/wiki/ExtDnd5
         dnd5: {
            // autoExpandMS: 400,
            preventForeignNodes: true,  // Prevent dropping nodes from another Fancytree
            preventRecursion: true,     // Prevent dropping nodes on own descendants
            preventVoidMoves: true,     // Prevent moving nodes 'before self', etc.
            preventNonNodes: true,      // Prevent dropping items other than Fancytree nodes
            // effectAllowed: "all",
            // dropEffectDefault: "move", // "auto",

            // --- Drag-support:
            dragStart: function(node, data) {
              /* This function MUST be defined to enable dragging for the tree.
                *
                * Return false to cancel dragging of node.
                * data.dataTransfer.setData() and .setDragImage() is available
                * here.
                */

              // Set the allowed effects (i.e. override the 'effectAllowed' option)
              data.effectAllowed = "all";

              // Set a drop effect (i.e. override the 'dropEffectDefault' option)
              // data.dropEffect = "link";
              data.dropEffect = "copy";

              // Return true to allow the drag operation
              return true;
            },
            // dragDrag: function(node, data) {
            // },
            // dragEnd: function(node, data) {
            // },

            // --- Drop-support:

            dragEnter: function(node, data) {
               //console.log("dragEnter node:", node);
               //console.log("dragEnter data:", data);

               //if(!node.folder && data.hitMode === "over"){
               if(!node.folder){
                 console.warn("dragEnter: No, "+node.key+" is not a folder, you can't drop it here !");
                 return false;
               }

              //data.dropEffect = "copy";
              console.warn("dragEnter: return true");
              return true;
            },
            dragOver: function(node, data) {
               // rem: node is the one that is under the cursor
               // rem: data.otherNode is the one that is selected & moved
//console.log("dragOver node:", node);
//console.log("dragOver data:", data);

               if(!node.folder && data.hitMode === "over"){
                 //console.warn("dragOver: No, this is not a folder, you can't drop it here !");
                 return false;
               }

              // Assume typical mapping for modifier keys
              data.dropEffect = data.dropEffectSuggested;
              // data.dropEffect = "move";
            },
            dragDrop: function(node, data) {
              /* This function MUST be defined to enable dropping of items on
                * the tree.
                */
console.log("dragDrop data:", data);

               if(!node.folder){
                 console.error("No! you cant drop a node ("+data.otherNode.key+") on an issue "+node.key);
                 return false;
               }
               if( data.otherNode ) {
                 data.otherNode.moveTo(node, data.hitMode);
               } else {
                 // Drop a non-node
                 console.error("drop non-node !");
               }
               // Expand target node when a child was created:
               node.setExpanded();
            }

           }, // dnd5

            // -----------------------
            edit: {
              //triggerStart: ["clickActive", "dblclick", "f2", "mac+enter", "shift+click"],
              triggerStart: ["dblclick", "shift+click"],
              beforeEdit: function(event, data){
               if(!data.node.folder){
                 console.warn("No! you can only edit folders");
                 return false;
               }
               if (1 >= data.node.getLevel() ) {
                 console.warn("No! you can't edit the root element "+data.node.getLevel());
                 return false;
               }
              },
              edit: function(event, data){
                // Editor was opened (available as data.input)
              },
              beforeClose: function(event, data){
                // Return false to prevent cancel/save (data.input is available)
              },
              save: function(event, data){
                // Save data.input.val() or return false to keep editor open
                console.log("save...", this, data);
                data.node.setTitle(data.node.title + "!");
                // We return true, so ext-edit will set the current user input as title
                return true;
              },
              close: function(event, data){
                // Editor was removed
                //if( data.save ) {

              }
            }
        });

        addContextMenu();
     }


      function deleteNode(node) {
         if (node.getLevel() != 1 && !node.hasChildren()) {
             node.remove();
             // fancytree prefixes new nodes with '_'
             if ('_' !== node.data.key.charAt(0)) {
                // node exist in DB and must be removed
                nodesToDelete.push(node.data.key);
             }
         } else if (node.getLevel() == 1) {
            console.error("Root element cannot be deleted.")
            alert("{t}Root element cannot be deleted.{/t}");
         } else {
            console.error("Delete Failed: Folder must be empty.")
            alert("{t}Delete Failed: Folder must be empty.{/t}");
         }
      }

      function saveTree() {

         var deferred = jQuery.Deferred();

         var json = $("#tree").fancytree("getRoot").toDict(true, function(dict){
            delete dict.isLazy;
            delete dict.tooltip;
            delete dict.href;
            //delete dict.icon;
            delete dict.addClass;
            delete dict.noLink;
            delete dict.activate;
            delete dict.focus;
            //delete dict.expand;
            delete dict.select;
            delete dict.hideCheckbox;
            delete dict.unselectable;
         }).children;
         var jsonDict = JSON.stringify(json);
         $.ajax({
            type: "POST",
              url: 'include/fancytree_ajax.php',
              data: { jsonDynatreeDict: jsonDict,
                      nodesToDelete: nodesToDelete,
                      wbsRootId: "{$wbsRootId}",
                      action: "saveWBS"
              },
              success: function() {
                 nodesToDelete = [];
                 //alert("WBS Saved!");
                 console.log("saveWBS: OK");
                 $("#result").html('WBS saved.');
                 // call the 'done' callback (should be defined)
                 deferred.resolve();
              },
              error:  function() {
                 alert("WBS Save ERROR!");
                 console.error("WBS Save ERROR!")
                 deferred.reject(); // call the 'fail' callback (if defined)
              }
         });
         return deferred;
      }

	  window.onload = initTree;


</script>


